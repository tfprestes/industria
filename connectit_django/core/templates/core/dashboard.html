{# ============================================================================== #}
{# core/dashboard.html - v2 (Refatorado pelo Arquiteto de Software)             #}
{# ============================================================================== #}
{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - ConnectIT{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}

{% block content %}
    <h1 class="dashboard-title">Dashboard Geral</h1>

    <div class="metrics-grid">
        {# ARQUITETO: Corrigido os nomes das variáveis para bater com o contexto da View #}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-desktop' title='Computadores' total_value=pcs_metrics.total new_value=pcs_metrics.em_uso unit='' %}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-mobile-alt' title='Celulares' total_value=cellphones_metrics.total new_value=cellphones_metrics.em_uso unit='' %}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-print' title='Impressoras' total_value=printers_metrics.total new_value=printers_metrics.em_uso unit='' %}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-hdd' title='Desktops' total_value=desktops.total new_value=desktops.em_uso unit='' %}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-boxes' title='Itens Inventário' total_value=inventory_metrics.total new_value=inventory_metrics.em_estoque unit='' %}
        {% include 'core/components/_metric_card.html' with icon_class='fas fa-file-contract' title='Contratos & Veículos' total_value=contracts_vehicles.total new_value=contracts_vehicles.ativos unit='' %}
    </div>

    <div class="charts-row">
        {% include 'core/components/_bar_chart_horizontal.html' with chart_id='costsByComputerSectorChart' title='Custo por Setor (Computadores)' chart_data=costs_by_computer_sector_chart_data %}
        {% include 'core/components/_bar_chart_horizontal.html' with chart_id='costsByCellphoneSectorChart' title='Custo por Setor (Celulares)' chart_data=costs_by_cellphone_sector_chart_data %}
    </div>
    <div class="charts-row">
        {% include 'core/components/_bar_chart_horizontal.html' with chart_id='costsByPrinterSectorChart' title='Custo por Setor (Impressoras)' chart_data=costs_by_printer_sector_chart_data %}
        {% include 'core/components/_stacked_bar_chart.html' with chart_id='softwareDistributionChart' title='Distribuição de Software por Setor' chart_data=software_distribution_by_sector_chart_data %}
    </div>

    <div class="charts-row">
        <div class="dashboard-panel panel-half">
            <h3>Alertas Importantes</h3>
            <ul class="alert-list">
                {% for alert in important_alerts %}
                    <li class="alert-item alert-{{ alert.severity|default:'info' }}">
                        <i class="fas fa-exclamation-triangle"></i> {{ alert.description }}
                    </li>
                {% empty %}
                    <li class="no-data">Nenhum alerta importante no momento.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="dashboard-panel panel-half">
            <h3>Pagamentos a Vencer</h3>
            <ul class="payment-list">
                {% for payment in payments_due_soon %}
                    <li>
                        <span class="payment-description">{{ payment.description }}</span>
                        <span class="payment-amount">R$ {{ payment.value|floatformat:2 }}</span> {# Corrigido para payment.value #}
                        <span class="payment-date">({{ payment.due_date|date:"d/m/Y" }})</span> {# Adicionado filtro de data #}
                    </li>
                {% empty %}
                    <li class="no-data">Nenhum pagamento a vencer em breve.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="charts-row">
        <div class="dashboard-panel panel-half">
            <h3>Inventário de Software</h3>
            <ul class="software-list">
                {% for software in software_inventory_list %}
                    <li>{{ software.name }} ({{ software.count }} licenças)</li>
                {% empty %}
                    <li class="no-data">Nenhum software registrado.</li>
                {% endfor %}
            </ul>
        </div>
        {% include 'core/components/_line_chart.html' with chart_id='costEvolutionChart' title='Evolução de Custos' chart_data=cost_evolution_chart_data %}
    </div>

{% endblock %}

{% block extra_scripts %}
    {# ARQUITETO: Lógica JS movida para um arquivo estático para melhor organização #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="{% static 'js/dashboard_charts.js' %}"></script>
{% endblock %}